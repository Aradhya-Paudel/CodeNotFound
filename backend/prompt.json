{
  "task": "Implement Blood Transfer System (Scenario 3) and Proximity Button",
  "overview": "Add mathematical logic for inter-hospital blood transfer and proximity-based casualty reporting button",
  
  "requirements": {
    "scenario_3_flow": {
      "step_1": "Ambulance 15km from Hospital A needs blood (e.g., 8L O-)",
      "step_2": "Hospital A only has 3L O- (INSUFFICIENT)",
      "step_3": "Hospital A clicks 'Ask for Help' button",
      "step_4": "System finds Hospital B (nearest to Hospital A) that has required blood (e.g., 20L O-)",
      "step_5": "Blood request sent to Hospital B",
      "step_6": "Hospital B views and approves request",
      "step_7": "System finds nearest ambulance to Hospital B",
      "step_8": "Ambulance dispatched from Hospital B to Hospital A with blood",
      "step_9": "Blood delivered to Hospital A",
      "step_10": "Hospital A now has enough blood for original casualties"
    },
    
    "proximity_button_flow": {
      "trigger": "When ambulance is within 10 meters of casualty location",
      "action": "Show 'Casualty' button",
      "on_click": "Open casualty popup to enter: number of casualties, blood type, blood required, severity, specialty required",
      "after_submit": "Create casualty records and find optimal hospital"
    }
  },
  
  "implementation_tasks": [
    {
      "task_1": "Blood Availability Checker",
      "file": "backend/src/utils/bloodChecker.js",
      "function": "checkBloodAvailability(hospitalId, requiredBlood)",
      "logic": [
        "Read hospital from hospitals.json",
        "For each required blood type, check if hospital.bloodInventory has sufficient liters",
        "Return: { sufficient: boolean, details: [{ bloodType, required, available, shortage }] }"
      ],
      "example": "Hospital needs 8L O-, has 3L → returns { sufficient: false, shortage: 5 }"
    },
    
    {
      "task_2": "Update Hospital Finder to Check Blood",
      "file": "backend/src/controllers/hospitalController.js",
      "endpoint": "POST /api/hospitals/find-optimal",
      "change": "Add blood availability check using checkBloodAvailability()",
      "response_must_include": {
        "bloodAvailability": {
          "sufficient": false,
          "details": [{ "bloodType": "O-", "required": 8, "available": 3, "shortage": 5 }]
        }
      },
      "frontend_action": "If bloodAvailability.sufficient = false, show 'Ask for Help' button"
    },
    
    {
      "task_3": "Blood Request Creation",
      "file": "backend/src/controllers/bloodRequestController.js",
      "endpoint": "POST /api/blood-requests/create",
      "request_body": {
        "fromHospitalId": 1,
        "bloodType": "O-",
        "litersNeeded": 8
      },
      "logic": [
        "Get requesting hospital location",
        "Find all hospitals within 50km",
        "Filter hospitals that have >= litersNeeded of bloodType",
        "Sort by distance (nearest first)",
        "Create blood request: { requestId, fromHospitalId, toHospitalId, bloodType, litersNeeded, status: 'pending', distanceKm }",
        "Save to blood_requests.json",
        "Add to target hospital's bloodRequests array"
      ],
      "response": {
        "request": "created blood request object",
        "targetHospital": "hospital object with blood",
        "distance": "km between hospitals"
      }
    },
    
    {
      "task_4": "Blood Request Approval",
      "endpoint": "POST /api/blood-requests/:requestId/approve",
      "request_body": { "hospitalId": 2 },
      "logic": [
        "Verify hospitalId matches request.toHospitalId",
        "Find nearest ACTIVE ambulance to approving hospital",
        "Update request: status='approved', ambulanceAssigned",
        "SUBTRACT blood from approving hospital: newLiters = currentLiters - litersNeeded",
        "Update ambulance: status='busy', currentCasualtyId=requestId",
        "Save all changes"
      ],
      "math_example": "Hospital has 20L, needs to send 8L → 20 - 8 = 12L remaining",
      "response": {
        "ambulance": "assigned ambulance object",
        "route": { "from": "hospital B location", "to": "hospital A location" }
      }
    },
    
    {
      "task_5": "Blood Delivery Completion",
      "endpoint": "POST /api/blood-requests/:requestId/complete",
      "request_body": { "ambulanceName": "ambulance-id" },
      "logic": [
        "Verify request status='approved' and ambulanceName matches",
        "ADD blood to requesting hospital: newLiters = currentLiters + litersNeeded",
        "Update request: status='completed'",
        "Update ambulance: status='active', currentCasualtyId=null",
        "Save all changes"
      ],
      "math_example": "Hospital has 3L, receives 8L → 3 + 8 = 11L total"
    },
    
    {
      "task_6": "Proximity Check Utility",
      "file": "backend/src/utils/geoUtils.js",
      "function": "isWithinProximity(lat1, lon1, lat2, lon2, radiusMeters)",
      "logic": [
        "Use existing calculateDistance() to get distance in km",
        "Convert to meters: distanceMeters = distanceKm * 1000",
        "Return: distanceMeters <= radiusMeters"
      ],
      "threshold": "10 meters"
    },
    
    {
      "task_7": "Proximity Check Endpoint",
      "file": "backend/src/controllers/ambulanceController.js",
      "endpoint": "POST /api/ambulances/:name/check-proximity",
      "request_body": {
        "currentLatitude": 28.2096,
        "currentLongitude": 83.9856,
        "destinationLatitude": 28.2097,
        "destinationLongitude": 83.9857,
        "proximityThreshold": 10
      },
      "response": {
        "withinProximity": true,
        "distanceMeters": 8.5,
        "showCasualtyButton": true
      },
      "frontend_action": "If withinProximity = true, show 'Casualty' button at bottom right"
    },
    
    {
      "task_8": "Casualty Reporting on Arrival",
      "endpoint": "POST /api/casualties/report-on-arrival",
      "request_body": {
        "ambulanceName": "MH-02-AB-1001",
        "accidentId": "ACC-001",
        "casualties": [
          { "bloodType": "O-", "bloodRequired": 5, "severity": "critical", "specialtyRequired": "Trauma Surgeon" },
          { "bloodType": "O-", "bloodRequired": 3, "severity": "urgent", "specialtyRequired": "Orthopedic Surgeon" }
        ]
      },
      "logic": [
        "Create casualties with IDs: CAS-{timestamp}-{index}",
        "Save to casualties.json",
        "Automatically call findOptimalHospital()",
        "Return casualties and hospital match with blood availability"
      ]
    }
  ],
  
  "mathematical_validation": {
    "blood_math": [
      "Hospital A needs 8L O-, has 3L → insufficient (shortage: 5L)",
      "Hospital B has 20L O-",
      "After approval: Hospital B = 20 - 8 = 12L",
      "After delivery: Hospital A = 3 + 8 = 11L"
    ],
    "distance_calculations": [
      "Use Haversine formula for all distances",
      "Convert km to meters for proximity: km * 1000",
      "Example: 0.008 km = 8 meters (within 10m threshold)"
    ]
  },
  
  "data_files_to_create": [
    {
      "file": "backend/data/blood_requests.json",
      "initial": "[]",
      "structure": {
        "requestId": "BR-{timestamp}",
        "fromHospitalId": "number",
        "toHospitalId": "number",
        "bloodType": "string",
        "litersNeeded": "number",
        "status": "pending/approved/completed",
        "distanceKm": "number",
        "ambulanceAssigned": "string or null"
      }
    }
  ],
  
  "routes_to_add": [
    "POST /api/blood-requests/create",
    "POST /api/blood-requests/:requestId/approve",
    "POST /api/blood-requests/:requestId/complete",
    "GET /api/hospitals/:id/blood-requests",
    "POST /api/ambulances/:name/check-proximity",
    "POST /api/casualties/report-on-arrival"
  ],
  
  "frontend_integration_notes": {
    "scenario_3_trigger": "When findOptimalHospital returns bloodAvailability.sufficient = false, show 'Ask for Help' button",
    "proximity_trigger": "Call check-proximity endpoint every 5 seconds while ambulance is en route. When withinProximity = true, show 'Casualty' button",
    "blood_request_flow": "Hospital views pending requests in dashboard → clicks approve → ambulance auto-assigned and dispatched"
  },
  
  "execution_order": [
    "1. Create bloodChecker.js utility",
    "2. Update hospitalController.js to check blood availability",
    "3. Create bloodRequestController.js with create/approve/complete endpoints",
    "4. Add proximity functions to geoUtils.js",
    "5. Add check-proximity endpoint to ambulanceController.js",
    "6. Add report-on-arrival endpoint to casualtyController.js",
    "7. Create bloodRequestRoutes.js and add to server.js",
    "8. Test with sample data: Hospital needs 8L, has 3L, another has 20L"
  ],
  
  "critical_rules": [
    "Use JSON files for storage (no database yet)",
    "All blood math must be verified: subtraction for sending, addition for receiving",
    "Proximity threshold is exactly 10 meters",
    "Only ACTIVE ambulances can be assigned to blood transfers",
    "Distance calculations use Haversine formula",
    "Blood requests can only be approved by target hospital (toHospitalId)"
  ],
  
  "success_criteria": {
    "scenario_3": "Hospital A (3L) requests blood → Hospital B (20L) approves → Ambulance delivers → Hospital A now has 11L (3+8)",
    "proximity": "Ambulance within 10m of casualty → check-proximity returns withinProximity=true → 'Casualty' button appears"
  }
}